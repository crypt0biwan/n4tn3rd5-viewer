<html>
    <head>
        <link href="./css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link href="./css/bootstrap-icons.min.css" rel="stylesheet">


        <style type="text/css">
            body { 
                background-color: #282828;
            }

            #result { 
                width: 100%; 
                height: 100%;
            }
            
            
            svg { 
                width: 100% !important; 
                max-width: 100vw !important;
                height: auto !important;
                max-height: 94vh !important;
            }
        </style>
    </head>

    <body>
        <div class="container-fluid p-0">
            <div class="row row-cols-1 g-0">
                <div id="result">

                </div>

                <div class="col">
                    <div class="row row-cols-2 mx-0 py-2 g-3">
                        <div class="col-12 col-md-6 pt-1 pt-md-0">
                            <div class="d-grid">
                                <button class="btn btn-primary btn-download" data-type="svg">DOWNLOAD SVG</button>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="d-grid">
                                <button class="btn btn-primary btn-download" data-type="png">DOWNLOAD 3840x3840 PNG</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tmp" style="display: none"></div>

        <script>
            let blockNumber = '38304'

            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            })

            if(params && params.n4tn3rd5) {
                blockNumber = params.n4tn3rd5
            }

            document.title = `N4tn3rd5 #${blockNumber}`

            const fetchImage = async url => {
                const response = await fetch(url)
                return await response.text()
            }

            const downloadImage = async url => {
                const svgHTML = await fetchImage(url)
                document.querySelector('#result').innerHTML = svgHTML
            }

            downloadImage(`./svg/${blockNumber}.svg`)


            document.querySelectorAll('.btn-download').forEach(btn => btn.addEventListener('click', e => {
                e.preventDefault();

                if(e.target.getAttribute('data-type') === 'svg') {
                    downloadFile(getSvgUrl(document.querySelector('#result').innerHTML))
                } else {
                    svgToPng(document.querySelector('#result').innerHTML, imgData => {
                        downloadFile(imgData)
                    })
                }
            }))

            function svgToPng(svg, callback) {
                const url = getSvgUrl(svg)
                svgUrlToPng(url, (imgData) => {
                    callback(imgData)
                    URL.revokeObjectURL(url)
                });
            }

            function getSvgUrl(svg) {
                return URL.createObjectURL(new Blob([svg], { type: 'image/svg+xml' }))
            }
            
            function svgUrlToPng(svgUrl, callback) {
                const svgImage = document.createElement('img')
                svgImage.setAttribute('id', 'png-image')
                svgImage.setAttribute('style', 'display: none')
                document.querySelector('#tmp').appendChild(svgImage)
                svgImage.onload = function () {
                    const canvas = document.createElement('canvas')
                    canvas.width = 3840
                    canvas.height = 3840
                    const canvasCtx = canvas.getContext('2d')
                    canvasCtx.drawImage(svgImage, 0, 0)
                    const imgData = canvas.toDataURL('image/png')
                    callback(imgData)
                }
                svgImage.src = svgUrl
            }

            function downloadFile(file) {
                const link = document.createElement("a")
                link.style.display = "none"
                link.href = file
                link.download = `N4tn3rd #${blockNumber}`

                document.querySelector('#tmp').appendChild(link)
                link.click()
            }
        </script>
    </body>
</html>